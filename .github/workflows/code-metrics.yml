name: üìä Code Metrics & Quality Gate

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ master ]
    types: [ opened, synchronize, reopened ]
  schedule:
    - cron: '0 2 * * 1' # Tous les lundis √† 2h
  workflow_dispatch:
    inputs:
      create_issue:
        description: 'Cr√©er une issue en cas de probl√®me'
        required: false
        default: 'true'
        type: boolean
      slack_notification:
        description: 'Envoyer une notification Slack'
        required: false
        default: 'true'
        type: boolean

env:
  PHP_VERSION: '8.3'

permissions:
  issues: write
  pull-requests: write
  contents: write


jobs:
  quality-gate:
    name: üö¶ Quality Gate - M√©triques & Seuils
    runs-on: ubuntu-latest
    outputs:
      quality-status: ${{ steps.quality-check.outputs.status }}
      complexity-score: ${{ steps.quality-check.outputs.complexity }}
      maintainability-score: ${{ steps.quality-check.outputs.maintainability }}
      coverage-score: ${{ steps.quality-check.outputs.coverage }}
      violations-count: ${{ steps.quality-check.outputs.violations }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, imagick
          coverage: xdebug

      - name: üì¶ Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}-metrics
          restore-keys: |
            composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}-
            composer-${{ runner.os }}-

      - name: üì¶ Install dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      - name: üì¶ Install dependencies
        run: npm install

      - name: üîß Build assets
        run: npm run build

      - name: üìÅ Create reports directory
        run: mkdir -p reports/metrics

      - name: üìä Generate PHPMetrics report
        run: |
          ./vendor/bin/phpmetrics --report-html=reports/metrics --report-json=reports/metrics/metrics.json app/

      - name: üìà Generate PHPStan analysis
        run: |
          ./vendor/bin/phpstan analyse --no-progress --error-format=json > reports/metrics/phpstan.json || true
          ./vendor/bin/phpstan analyse --no-progress --error-format=table > reports/metrics/phpstan.txt || true

      - name: Configure Laravel
        run: |
          cp .env.github .env
          php artisan key:generate

      - name: Write secrets to .env
        run: |
          echo "BRIDGE_CLIENT_ID=${{ secrets.BRIDGE_CLIENT_ID }}" >> .env
          echo "BRIDGE_CLIENT_SECRET=${{ secrets.BRIDGE_CLIENT_SECRET }}" >> .env

      - name: üß™ Run tests with coverage
        run: |
          php artisan migrate --force
          ./vendor/bin/pest --coverage --coverage-clover=reports/metrics/coverage.xml --coverage-html=reports/metrics/coverage

      - name: üé® Check code style
        run: |
          ./vendor/bin/pint --test > reports/metrics/pint.txt || echo "Style issues detected"

      - name: üö¶ Analyze quality metrics
        id: quality-check
        run: |
          # Initialiser les variables
          QUALITY_STATUS="success"
          COMPLEXITY_SCORE=0
          MAINTAINABILITY_SCORE=0
          COVERAGE_SCORE=0
          VIOLATIONS_COUNT=0

          # Analyser PHPMetrics (si le fichier JSON existe)
          if [ -f "reports/metrics/metrics.json" ]; then
            # Extraire les m√©triques principales (approximation)
            COMPLEXITY_SCORE=$(jq -r '.complexity // 0' reports/metrics/metrics.json 2>/dev/null || echo "0")
            MAINTAINABILITY_SCORE=$(jq -r '.maintainability // 0' reports/metrics/metrics.json 2>/dev/null || echo "0")
          fi

          # Analyser la couverture de code
          if [ -f "reports/metrics/coverage.xml" ]; then
            echo "üîç Analyse du fichier de couverture..."
            echo "üìÑ Aper√ßu du fichier coverage.xml (premi√®res lignes):"
            head -20 reports/metrics/coverage.xml
            
            # M√©thode 1: Format Clover XML (utilis√© par Pest)
            COVERAGE_SCORE=$(grep -E '<metrics.*statements=' reports/metrics/coverage.xml | head -1 | sed -n 's/.*coveredstatements="\([0-9]*\)".*statements="\([0-9]*\)".*/\1 \2/p' | awk '{if($2>0) print ($1/$2)*100; else print 0}' || echo "0")
            
            # M√©thode 2: Chercher les m√©triques de couverture avec pourcentage direct
            if [ "$COVERAGE_SCORE" = "0" ]; then
              COVERAGE_SCORE=$(grep -E 'lines-covered|statements-covered' reports/metrics/coverage.xml | head -1 | grep -oE 'percent="[0-9.]+"' | grep -oE '[0-9.]+' || echo "0")
            fi
            
            # M√©thode 3: Parser les m√©triques du projet global
            if [ "$COVERAGE_SCORE" = "0" ]; then
              TOTAL_STATEMENTS=$(grep -E '<coverage.*>' reports/metrics/coverage.xml | grep -oE 'statements="[0-9]+"' | grep -oE '[0-9]+' || echo "0")
              COVERED_STATEMENTS=$(grep -E '<coverage.*>' reports/metrics/coverage.xml | grep -oE 'coveredstatements="[0-9]+"' | grep -oE '[0-9]+' || echo "0")
              if [ "$TOTAL_STATEMENTS" != "0" ] && [ "$COVERED_STATEMENTS" != "0" ]; then
                COVERAGE_SCORE=$(awk "BEGIN {printf \"%.2f\", ($COVERED_STATEMENTS/$TOTAL_STATEMENTS)*100}")
              fi
            fi
            
            # M√©thode 4: Parser avec xmllint si disponible
            if [ "$COVERAGE_SCORE" = "0" ] && command -v xmllint >/dev/null 2>&1; then
              TOTAL_STATEMENTS=$(xmllint --xpath "string(//coverage/project/metrics/@statements)" reports/metrics/coverage.xml 2>/dev/null || echo "0")
              COVERED_STATEMENTS=$(xmllint --xpath "string(//coverage/project/metrics/@coveredstatements)" reports/metrics/coverage.xml 2>/dev/null || echo "0")
              if [ "$TOTAL_STATEMENTS" != "0" ] && [ "$COVERED_STATEMENTS" != "0" ]; then
                COVERAGE_SCORE=$(awk "BEGIN {printf \"%.2f\", ($COVERED_STATEMENTS/$TOTAL_STATEMENTS)*100}")
              fi
            fi
            
            # M√©thode 5: Fallback - chercher n'importe quel pourcentage dans le fichier
            if [ "$COVERAGE_SCORE" = "0" ]; then
              COVERAGE_SCORE=$(grep -oE 'percent="[0-9.]+"' reports/metrics/coverage.xml | head -1 | grep -oE '[0-9.]+' || echo "0")
            fi
            
            # Arrondir √† 2 d√©cimales
            COVERAGE_SCORE=$(printf "%.2f" "$COVERAGE_SCORE" 2>/dev/null || echo "0")
            
            echo "üìä Couverture extraite: ${COVERAGE_SCORE}%"
          else
            echo "‚ö†Ô∏è Fichier coverage.xml non trouv√©"
          fi

          # Analyser PHPStan
          if [ -f "reports/metrics/phpstan.json" ]; then
            VIOLATIONS_COUNT=$(jq '.totals.file_errors // 0' reports/metrics/phpstan.json 2>/dev/null || echo "0")
          fi

          # D√©finir les seuils de qualit√©
          MIN_COVERAGE=70
          MAX_VIOLATIONS=10
          MAX_COMPLEXITY=10

          # V√©rifier les seuils
          echo "üìä M√©triques de qualit√©:"
          echo "- Couverture de code: ${COVERAGE_SCORE}% (min: ${MIN_COVERAGE}%)"
          echo "- Violations PHPStan: ${VIOLATIONS_COUNT} (max: ${MAX_VIOLATIONS})"
          echo "- Complexit√© moyenne: ${COMPLEXITY_SCORE} (max: ${MAX_COMPLEXITY})"

          # D√©terminer le statut global
          if (( $(echo "$COVERAGE_SCORE < $MIN_COVERAGE" | bc -l) )); then
            echo "‚ùå Couverture de code insuffisante: ${COVERAGE_SCORE}% < ${MIN_COVERAGE}%"
            QUALITY_STATUS="failed"
          fi

          if (( VIOLATIONS_COUNT > MAX_VIOLATIONS )); then
            echo "‚ùå Trop de violations PHPStan: ${VIOLATIONS_COUNT} > ${MAX_VIOLATIONS}"
            QUALITY_STATUS="failed"
          fi

          # Exporter les r√©sultats
          echo "status=$QUALITY_STATUS" >> $GITHUB_OUTPUT
          echo "complexity=$COMPLEXITY_SCORE" >> $GITHUB_OUTPUT
          echo "maintainability=$MAINTAINABILITY_SCORE" >> $GITHUB_OUTPUT
          echo "coverage=$COVERAGE_SCORE" >> $GITHUB_OUTPUT
          echo "violations=$VIOLATIONS_COUNT" >> $GITHUB_OUTPUT

          # Cr√©er un r√©sum√© d√©taill√©
          cat > reports/metrics/quality-summary.md << EOF
          # üìä Rapport de Qualit√© - $(date)

          ## üéØ Statut Global: $([ "$QUALITY_STATUS" = "success" ] && echo "‚úÖ SUCC√àS" || echo "‚ùå √âCHEC")

          ## üìà M√©triques Principales
          - **Couverture de code**: ${COVERAGE_SCORE}% $([ $(echo "$COVERAGE_SCORE >= $MIN_COVERAGE" | bc -l) -eq 1 ] && echo "‚úÖ" || echo "‚ùå")
          - **Violations PHPStan**: ${VIOLATIONS_COUNT} $([ $VIOLATIONS_COUNT -le $MAX_VIOLATIONS ] && echo "‚úÖ" || echo "‚ùå")
          - **Complexit√© moyenne**: ${COMPLEXITY_SCORE}

          ## üìÅ Structure du Projet
          EOF

          # Ajouter les statistiques de fichiers
          echo "- Fichiers PHP: $(find app/ -name "*.php" | wc -l)" >> reports/metrics/quality-summary.md
          echo "- Fichiers de tests: $(find tests/ -name "*.php" | wc -l)" >> reports/metrics/quality-summary.md
          echo "" >> reports/metrics/quality-summary.md
          echo "## üèóÔ∏è Modules" >> reports/metrics/quality-summary.md
          for module in Chantiers RH Tiers Commerce Produit Core; do
            count=$(find app/Models/$module app/Livewire/*$module* -name "*.php" 2>/dev/null | wc -l)
            echo "- $module: $count fichiers" >> reports/metrics/quality-summary.md
          done

          # √âchec si quality gate √©choue
          if [ "$QUALITY_STATUS" = "failed" ]; then
            echo "üö´ Quality Gate √©chou√© - Les seuils de qualit√© ne sont pas respect√©s"
            exit 1
          fi

      - name: üì§ Upload metrics artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-metrics-${{ github.sha }}
          path: reports/metrics/
          retention-days: 30

      - name: üìä Comment PR with metrics
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'reports/metrics/quality-summary.md';

            if (fs.existsSync(path)) {
              const summary = fs.readFileSync(path, 'utf8');

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## üìä Rapport de Qualit√© du Code\n\n${summary}\n\n---\n*G√©n√©r√© automatiquement par le workflow Code Metrics*`
              });
            }

  notifications:
    name: üì¢ Notifications
    runs-on: ubuntu-latest
    needs: quality-gate
    if: always() && (needs.quality-gate.outputs.quality-status == 'failed' || github.event.inputs.slack_notification == 'true')
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üî¥ Create GitHub Issue on failure
        if: needs.quality-gate.outputs.quality-status == 'failed' && (github.event.inputs.create_issue == 'true' || github.event.inputs.create_issue == '')
        uses: actions/github-script@v7
        with:
          script: |
            const title = `üö® Quality Gate Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `## üö´ Quality Gate Failure

            Le workflow de m√©triques de code a √©chou√© sur la branche \`${{ github.ref_name }}\`.

            ### üìä M√©triques
            - **Couverture de code**: ${{ needs.quality-gate.outputs.coverage-score }}%
            - **Violations PHPStan**: ${{ needs.quality-gate.outputs.violations-count }}
            - **Complexit√©**: ${{ needs.quality-gate.outputs.complexity-score }}

            ### üîó Liens
            - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [Commit](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})

            ### üìã Actions Requises
            - [ ] Am√©liorer la couverture de tests
            - [ ] Corriger les violations PHPStan
            - [ ] R√©duire la complexit√© du code
            - [ ] Relancer le workflow apr√®s corrections

            ---
            *Issue cr√©√©e automatiquement par le workflow Code Metrics*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['quality', 'metrics', 'bug']
            });

      - name: üì± Send Slack notification
        if: github.event.inputs.slack_notification == 'true' || needs.quality-gate.outputs.quality-status == 'failed'
        uses: actions/github-script@v7
        with:
           script: |
             // Note: N√©cessite la configuration d'un webhook Slack dans les secrets
             // SLACK_WEBHOOK doit √™tre d√©fini dans les secrets du repository

             const webhookUrl = '${{ secrets.SLACK_WEBHOOK }}';

             if (!webhookUrl) {
               console.log('‚ö†Ô∏è SLACK_WEBHOOK non configur√© dans les secrets du repository');
               return;
             }

             const status = '${{ needs.quality-gate.outputs.quality-status }}';
             const coverage = '${{ needs.quality-gate.outputs.coverage-score }}';
             const violations = '${{ needs.quality-gate.outputs.violations-count }}';

             const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
             const color = status === 'success' ? 'good' : 'danger';

             const message = {
               text: `${emoji} Code Metrics - ${status.toUpperCase()}`,
               attachments: [{
                 color: color,
                 fields: [
                   {
                     title: "Repository",
                     value: "${{ github.repository }}",
                     short: true
                   },
                   {
                     title: "Branch",
                     value: "${{ github.ref_name }}",
                     short: true
                   },
                   {
                     title: "Coverage",
                     value: `${coverage}%`,
                     short: true
                   },
                   {
                     title: "Violations",
                     value: violations,
                     short: true
                   }
                 ],
                 actions: [{
                   type: "button",
                   text: "View Workflow",
                   url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                 }]
               }]
             };

             try {
               const response = await fetch(webhookUrl, {
                 method: 'POST',
                 headers: {
                   'Content-Type': 'application/json',
                 },
                 body: JSON.stringify(message)
               });

               if (response.ok) {
                 console.log('‚úÖ Notification Slack envoy√©e avec succ√®s');
               } else {
                 console.log(`‚ùå Erreur lors de l'envoi Slack: ${response.status} ${response.statusText}`);
               }
             } catch (error) {
               console.log(`‚ùå Erreur lors de l'envoi Slack: ${error.message}`);
             }

  summary:
    name: üìã R√©sum√© Final
    runs-on: ubuntu-latest
    needs: [quality-gate, notifications]
    if: always()
    steps:
      - name: üìã Generate workflow summary
        run: |
          echo "## üìä R√©sum√© Code Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üéØ Statut: ${{ needs.quality-gate.outputs.quality-status == 'success' && '‚úÖ SUCC√àS' || '‚ùå √âCHEC' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìà M√©triques:" >> $GITHUB_STEP_SUMMARY
          echo "- **Couverture**: ${{ needs.quality-gate.outputs.coverage-score }}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Violations**: ${{ needs.quality-gate.outputs.violations-count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Complexit√©**: ${{ needs.quality-gate.outputs.complexity-score }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìÖ Ex√©cut√© le: $(date)" >> $GITHUB_STEP_SUMMARY
