name: ðŸ“Š Code Metrics & Quality Gate

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ master ]
    types: [ closed ]
  schedule:
    - cron: '0 2 * * 1' # Tous les lundis Ã  2h
  workflow_dispatch:
    inputs:
      create_issue:
        description: 'CrÃ©er une issue en cas de problÃ¨me'
        required: false
        default: 'true'
        type: boolean
      slack_notification:
        description: 'Envoyer une notification Slack'
        required: false
        default: 'true'
        type: boolean

env:
  PHP_VERSION: '8.3'

permissions:
  issues: write
  pull-requests: write
  contents: write


jobs:
  quality-gate:
    name: ðŸš¦ Quality Gate - MÃ©triques & Seuils
    runs-on: ubuntu-latest
    outputs:
      quality-status: ${{ steps.quality-check.outputs.status }}
      complexity-score: ${{ steps.quality-check.outputs.complexity }}
      maintainability-score: ${{ steps.quality-check.outputs.maintainability }}
      coverage-score: ${{ steps.quality-check.outputs.coverage }}
      violations-count: ${{ steps.quality-check.outputs.violations }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, imagick
          coverage: xdebug

      - name: ðŸ“¦ Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}-metrics
          restore-keys: |
            composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}-
            composer-${{ runner.os }}-

      - name: ðŸ“¦ Install dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      - name: ðŸ“¦ Install dependencies
        run: npm install

      - name: ðŸ”§ Build assets
        run: npm run build

      - name: ðŸ“ Create reports directory
        run: mkdir -p reports/metrics

      - name: ðŸ“Š Generate PHPMetrics report
        run: |
          ./vendor/bin/phpmetrics --report-html=reports/metrics --report-json=reports/metrics/metrics.json app/

      - name: ðŸ“ˆ Generate PHPStan analysis
        run: |
          ./vendor/bin/phpstan analyse --no-progress --error-format=json > reports/metrics/phpstan.json || true
          ./vendor/bin/phpstan analyse --no-progress --error-format=table > reports/metrics/phpstan.txt || true

      - name: Configure Laravel
        run: |
          cp .env.github .env
          php artisan key:generate

      - name: Write secrets to .env
        run: |
          echo "BRIDGE_CLIENT_ID=${{ secrets.BRIDGE_CLIENT_ID }}" >> .env
          echo "BRIDGE_CLIENT_SECRET=${{ secrets.BRIDGE_CLIENT_SECRET }}" >> .env

      - name: ðŸ§ª Run tests with coverage
        run: |
          php artisan migrate --force
          ./vendor/bin/pest --coverage --coverage-clover=reports/metrics/coverage.xml --coverage-html=reports/metrics/coverage

      - name: ðŸŽ¨ Check code style
        run: |
          ./vendor/bin/pint --test > reports/metrics/pint.txt || echo "Style issues detected"

      - name: ðŸš¦ Analyze quality metrics
        id: quality-check
        run: |
          # Initialiser les variables
          QUALITY_STATUS="success"
          COMPLEXITY_SCORE=0
          MAINTAINABILITY_SCORE=0
          COVERAGE_SCORE=0
          VIOLATIONS_COUNT=0

          # Analyser PHPMetrics (si le fichier JSON existe)
          if [ -f "reports/metrics/metrics.json" ]; then
            # Extraire les mÃ©triques principales (approximation)
            COMPLEXITY_SCORE=$(jq -r '.complexity // 0' reports/metrics/metrics.json 2>/dev/null || echo "0")
            MAINTAINABILITY_SCORE=$(jq -r '.maintainability // 0' reports/metrics/metrics.json 2>/dev/null || echo "0")
          fi

          # Analyser PHPStan
          if [ -f "reports/metrics/phpstan.json" ]; then
            VIOLATIONS_COUNT=$(jq '.totals.file_errors // 0' reports/metrics/phpstan.json 2>/dev/null || echo "0")
          fi

          # DÃ©finir les seuils de qualitÃ©
          MAX_VIOLATIONS=10
          MAX_COMPLEXITY=10

          # VÃ©rifier les seuils
          echo "ðŸ“Š MÃ©triques de qualitÃ©:"
          echo "- Violations PHPStan: ${VIOLATIONS_COUNT} (max: ${MAX_VIOLATIONS})"
          echo "- ComplexitÃ© moyenne: ${COMPLEXITY_SCORE} (max: ${MAX_COMPLEXITY})"

          if (( VIOLATIONS_COUNT > MAX_VIOLATIONS )); then
            echo "âŒ Trop de violations PHPStan: ${VIOLATIONS_COUNT} > ${MAX_VIOLATIONS}"
            QUALITY_STATUS="failed"
          fi

          # Exporter les rÃ©sultats
          echo "status=$QUALITY_STATUS" >> $GITHUB_OUTPUT
          echo "complexity=$COMPLEXITY_SCORE" >> $GITHUB_OUTPUT
          echo "maintainability=$MAINTAINABILITY_SCORE" >> $GITHUB_OUTPUT
          echo "violations=$VIOLATIONS_COUNT" >> $GITHUB_OUTPUT

          # CrÃ©er un rÃ©sumÃ© dÃ©taillÃ©
          cat > reports/metrics/quality-summary.md << EOF
          # ðŸ“Š Rapport de QualitÃ© - $(date)

          ## ðŸŽ¯ Statut Global: $([ "$QUALITY_STATUS" = "success" ] && echo "âœ… SUCCÃˆS" || echo "âŒ Ã‰CHEC")

          ## ðŸ“ˆ MÃ©triques Principales
          - **Violations PHPStan**: ${VIOLATIONS_COUNT} $([ $VIOLATIONS_COUNT -le $MAX_VIOLATIONS ] && echo "âœ…" || echo "âŒ")
          - **ComplexitÃ© moyenne**: ${COMPLEXITY_SCORE}

          ## ðŸ“ Structure du Projet
          EOF

          # Ajouter les statistiques de fichiers
          echo "- Fichiers PHP: $(find app/ -name "*.php" | wc -l)" >> reports/metrics/quality-summary.md
          echo "- Fichiers de tests: $(find tests/ -name "*.php" | wc -l)" >> reports/metrics/quality-summary.md
          echo "" >> reports/metrics/quality-summary.md
          echo "## ðŸ—ï¸ Modules" >> reports/metrics/quality-summary.md
          for module in Chantiers RH Tiers Commerce Produit Core; do
            count=$(find app/Models/$module app/Livewire/*$module* -name "*.php" 2>/dev/null | wc -l)
            echo "- $module: $count fichiers" >> reports/metrics/quality-summary.md
          done

          # Ã‰chec si quality gate Ã©choue
          if [ "$QUALITY_STATUS" = "failed" ]; then
            echo "ðŸš« Quality Gate Ã©chouÃ© - Les seuils de qualitÃ© ne sont pas respectÃ©s"
            exit 1
          fi

      - name: ðŸ“¤ Upload metrics artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-metrics-${{ github.sha }}
          path: reports/metrics/
          retention-days: 30

      - name: ðŸ“Š Comment PR with metrics
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'reports/metrics/quality-summary.md';

            if (fs.existsSync(path)) {
              const summary = fs.readFileSync(path, 'utf8');

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ðŸ“Š Rapport de QualitÃ© du Code\n\n${summary}\n\n---\n*GÃ©nÃ©rÃ© automatiquement par le workflow Code Metrics*`
              });
            }

  notifications:
    name: ðŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: quality-gate
    if: always() && (needs.quality-gate.outputs.quality-status == 'failed' || github.event.inputs.slack_notification == 'true')
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”´ Create GitHub Issue on failure
        if: needs.quality-gate.outputs.quality-status == 'failed' && (github.event.inputs.create_issue == 'true' || github.event.inputs.create_issue == '')
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Quality Gate Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `## ðŸš« Quality Gate Failure

            Le workflow de mÃ©triques de code a Ã©chouÃ© sur la branche \`${{ github.ref_name }}\`.

            ### ðŸ“Š MÃ©triques
            - **Violations PHPStan**: ${{ needs.quality-gate.outputs.violations-count }}
            - **ComplexitÃ©**: ${{ needs.quality-gate.outputs.complexity-score }}

            ### ðŸ”— Liens
            - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [Commit](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})

            ### ðŸ“‹ Actions Requises
            - [ ] Corriger les violations PHPStan
            - [ ] RÃ©duire la complexitÃ© du code
            - [ ] Relancer le workflow aprÃ¨s corrections

            ---
            *Issue crÃ©Ã©e automatiquement par le workflow Code Metrics*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['quality', 'metrics', 'bug']
            });

      - name: ðŸ“± Send Slack notification
        if: github.event.inputs.slack_notification == 'true' || needs.quality-gate.outputs.quality-status == 'failed'
        uses: actions/github-script@v7
        with:
           script: |
             // Note: NÃ©cessite la configuration d'un webhook Slack dans les secrets
             // SLACK_WEBHOOK doit Ãªtre dÃ©fini dans les secrets du repository

             const webhookUrl = '${{ secrets.SLACK_WEBHOOK }}';

             if (!webhookUrl) {
               console.log('âš ï¸ SLACK_WEBHOOK non configurÃ© dans les secrets du repository');
               return;
             }

             const status = '${{ needs.quality-gate.outputs.quality-status }}';
             const violations = '${{ needs.quality-gate.outputs.violations-count }}';

             const emoji = status === 'success' ? 'âœ…' : 'âŒ';
             const color = status === 'success' ? 'good' : 'danger';

             const message = {
               text: `${emoji} Code Metrics - ${status.toUpperCase()}`,
               attachments: [{
                 color: color,
                 fields: [
                   {
                     title: "Repository",
                     value: "${{ github.repository }}",
                     short: true
                   },
                   {
                     title: "Branch",
                     value: "${{ github.ref_name }}",
                     short: true
                   },
                   {
                     title: "Violations",
                     value: violations,
                     short: true
                   }
                 ],
                 actions: [{
                   type: "button",
                   text: "View Workflow",
                   url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                 }]
               }]
             };

             try {
               const response = await fetch(webhookUrl, {
                 method: 'POST',
                 headers: {
                   'Content-Type': 'application/json',
                 },
                 body: JSON.stringify(message)
               });

               if (response.ok) {
                 console.log('âœ… Notification Slack envoyÃ©e avec succÃ¨s');
               } else {
                 console.log(`âŒ Erreur lors de l'envoi Slack: ${response.status} ${response.statusText}`);
               }
             } catch (error) {
               console.log(`âŒ Erreur lors de l'envoi Slack: ${error.message}`);
             }

  summary:
    name: ðŸ“‹ RÃ©sumÃ© Final
    runs-on: ubuntu-latest
    needs: [quality-gate, notifications]
    if: always()
    steps:
      - name: ðŸ“‹ Generate workflow summary
        run: |
          echo "## ðŸ“Š RÃ©sumÃ© Code Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Statut: ${{ needs.quality-gate.outputs.quality-status == 'success' && 'âœ… SUCCÃˆS' || 'âŒ Ã‰CHEC' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ MÃ©triques:" >> $GITHUB_STEP_SUMMARY
          echo "- **Violations**: ${{ needs.quality-gate.outputs.violations-count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ComplexitÃ©**: ${{ needs.quality-gate.outputs.complexity-score }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“… ExÃ©cutÃ© le: $(date)" >> $GITHUB_STEP_SUMMARY
