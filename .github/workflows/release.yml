name: ðŸ“¦ Release

on:
  push:
    branches: [ production ]
  workflow_dispatch:

jobs:
  release:
    name: ðŸ“¦ Semantic Release
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/production'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Analyze changed modules
        id: modules
        run: |
          # Analyser les modules modifiÃ©s depuis le dernier tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            CHANGED_FILES=$(git diff --name-only $LAST_TAG..HEAD)
          else
            CHANGED_FILES=$(git ls-files)
          fi
          
          # DÃ©tecter les modules modifiÃ©s
          MODULES=""
          if echo "$CHANGED_FILES" | grep -q "app/.*Chantiers\|app/Models/Chantiers"; then
            MODULES="$MODULESðŸ¢ Chantiers "
          fi
          if echo "$CHANGED_FILES" | grep -q "app/.*RH\|app/Models/RH"; then
            MODULES="$MODULESðŸ‘¥ RH "
          fi
          if echo "$CHANGED_FILES" | grep -q "app/.*Tiers\|app/Models/Tiers"; then
            MODULES="$MODULESðŸ¤ Tiers "
          fi
          if echo "$CHANGED_FILES" | grep -q "app/.*Commerce\|app/Models/Commerce"; then
            MODULES="$MODULESðŸ’¼ Commerce "
          fi
          if echo "$CHANGED_FILES" | grep -q "app/.*Produit\|app/Models/Produit"; then
            MODULES="$MODULESðŸ“¦ Produits "
          fi
          if echo "$CHANGED_FILES" | grep -q "app/.*Core\|app/Models/Core"; then
            MODULES="$MODULESâš™ï¸ Core "
          fi
          
          echo "modules=$MODULES" >> $GITHUB_OUTPUT

      - name: ðŸš€ Semantic Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MODULES_CHANGED: ${{ steps.modules.outputs.modules }}
        run: npx semantic-release

      - name: ðŸ“Š Release Summary
        if: success()
        run: |
          echo "## ðŸŽ‰ Release crÃ©Ã©e avec succÃ¨s !" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ—ï¸ Modules modifiÃ©s dans cette release :" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.modules.outputs.modules }}" ]; then
            echo "${{ steps.modules.outputs.modules }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "Aucun module spÃ©cifique dÃ©tectÃ©" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ DÃ©tails :" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Version dÃ©tectÃ©e automatiquement par semantic-release" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ Changelog gÃ©nÃ©rÃ© automatiquement" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ·ï¸ Tag Git crÃ©Ã© automatiquement" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Release GitHub crÃ©Ã©e automatiquement" >> $GITHUB_STEP_SUMMARY
