name: ğŸ”’ Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 3 * * *' # Tous les jours Ã  3h
  workflow_dispatch:

jobs:
  security-scan:
    name: ğŸ”’ Analyse de sÃ©curitÃ©
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, imagick

      - name: ğŸ“¦ Install dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      - name: ğŸ” Composer security audit
        run: composer audit

      - name: ğŸ›¡ï¸ Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

      - name: ğŸ”’ SARIF security scan
        uses: github/super-linter/slim@v5
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_PHP_PHPSTAN: true
          VALIDATE_PHP_PSALM: false
          VALIDATE_DOCKERFILE_HADOLINT: true

  dependency-check:
    name: ğŸ” VÃ©rification des dÃ©pendances
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Run dependency check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'Batistack'
          path: '.'
          format: 'ALL'

      - name: ğŸ“¤ Upload results
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: reports/
