name: üîí Security Deep Scan

on:
  push:
    branches: [ develop, master, production ]
  pull_request:
    branches: [ master, production ]
    types: [ opened, synchronize, reopened ]
  schedule:
    - cron: '0 3 * * *' # Scan quotidien √† 3h
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type de scan de s√©curit√©'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - secrets-only
          - dependencies-only
          - vulnerabilities-only
      create_issue:
        description: 'Cr√©er une issue en cas de vuln√©rabilit√© critique'
        required: false
        default: 'true'
        type: boolean

permissions:
  issues: write
  pull-requests: write
  contents: write

env:
  PHP_VERSION: '8.3'

jobs:
  security-deep-scan:
    name: üîí Analyse de s√©curit√© approfondie
    runs-on: ubuntu-latest
    outputs:
      critical-vulnerabilities: ${{ steps.vulnerability-check.outputs.critical-count }}
      secrets-found: ${{ steps.secrets-scan.outputs.secrets-count }}
      security-status: ${{ steps.security-summary.outputs.status }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Historique complet pour l'analyse des secrets

      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, imagick

      - name: üì¶ Install dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      - name: üìÅ Create security reports directory
        run: mkdir -p reports/security

      - name: üõ°Ô∏è Advanced secrets detection
        id: secrets-scan
        continue-on-error: true
        if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'secrets-only' || github.event.inputs.scan_type == ''
        run: |
          echo "üîç Recherche avanc√©e de secrets..."

          # Scan avec TruffleHog (plus approfondi que module-ci.yml)
          docker run --rm -v "$PWD:/pwd" trufflesecurity/trufflehog:latest filesystem /pwd \
            --json --no-update > reports/security/trufflehog-detailed.json || true

          # Analyse personnalis√©e pour les patterns Laravel sp√©cifiques
          echo "üîç Recherche de patterns Laravel sensibles..."

          # Recherche de cl√©s API, tokens, mots de passe en dur
          grep -r -n -E "(api_key|secret_key|password|token|private_key)" \
            --include="*.php" --include="*.env*" --include="*.json" \
            app/ config/ database/ routes/ > reports/security/sensitive-patterns.txt || true

          # V√©rification des fichiers .env
          find . -name ".env*" -not -name ".env.example" -not -name ".env.github" \
            -exec echo "‚ö†Ô∏è Fichier .env d√©tect√©: {}" \; > reports/security/env-files.txt || true

          # Compter les secrets trouv√©s
          SECRETS_COUNT=$(wc -l < reports/security/sensitive-patterns.txt || echo "0")
          echo "secrets-count=$SECRETS_COUNT" >> $GITHUB_OUTPUT

          # Cr√©er un r√©sum√© structur√© des secrets pour l'issue
          if [ "$SECRETS_COUNT" -gt 0 ]; then
            echo "‚ö†Ô∏è $SECRETS_COUNT patterns sensibles d√©tect√©s"
            
            # Cr√©er un r√©sum√© des types de secrets d√©tect√©s
            echo "### üîë R√©sum√© des Secrets D√©tect√©s" > reports/security/secrets-summary.md
            echo "" >> reports/security/secrets-summary.md
            echo "**Total d√©tections**: $SECRETS_COUNT" >> reports/security/secrets-summary.md
            echo "" >> reports/security/secrets-summary.md
            
            # Analyser les types de patterns
            if grep -q "api_key" reports/security/sensitive-patterns.txt; then
              API_KEYS=$(grep -c "api_key" reports/security/sensitive-patterns.txt || echo "0")
              echo "- üîë **Cl√©s API**: $API_KEYS d√©tections" >> reports/security/secrets-summary.md
            fi
            
            if grep -q "password" reports/security/sensitive-patterns.txt; then
              PASSWORDS=$(grep -c "password" reports/security/sensitive-patterns.txt || echo "0")
              echo "- üîí **Mots de passe**: $PASSWORDS d√©tections" >> reports/security/secrets-summary.md
            fi
            
            if grep -q "token" reports/security/sensitive-patterns.txt; then
              TOKENS=$(grep -c "token" reports/security/sensitive-patterns.txt || echo "0")
              echo "- üé´ **Tokens**: $TOKENS d√©tections" >> reports/security/secrets-summary.md
            fi
            
            if grep -q "secret" reports/security/sensitive-patterns.txt; then
              SECRETS=$(grep -c "secret" reports/security/sensitive-patterns.txt || echo "0")
              echo "- ü§´ **Secrets**: $SECRETS d√©tections" >> reports/security/secrets-summary.md
            fi
            
            echo "" >> reports/security/secrets-summary.md
            echo "> ‚ö†Ô∏è **Action imm√©diate requise**: Tous ces √©l√©ments doivent √™tre supprim√©s du code source." >> reports/security/secrets-summary.md
          else
            echo "‚úÖ Aucun pattern sensible d√©tect√©"
            echo "### üîë Secrets et Patterns Sensibles" > reports/security/secrets-summary.md
            echo "‚úÖ **Aucun secret d√©tect√©** - Le code source est propre." >> reports/security/secrets-summary.md
          fi

      - name: üîç Vulnerability assessment
        id: vulnerability-check
        continue-on-error: true
        if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'vulnerabilities-only' || github.event.inputs.scan_type == ''
        run: |
          echo "üîç √âvaluation des vuln√©rabilit√©s..."

          # Audit Composer avec d√©tails
          composer audit --format=json > reports/security/composer-audit.json || true

          # Analyse des permissions de fichiers sensibles
          echo "üîí V√©rification des permissions de fichiers..."
          find storage/ -type f -name "*.log" -exec ls -la {} \; > reports/security/file-permissions.txt || true
          find . -name "*.env*" -exec ls -la {} \; >> reports/security/file-permissions.txt || true

          # V√©rification de la configuration de s√©curit√© Laravel
          echo "üõ°Ô∏è V√©rification de la configuration de s√©curit√© Laravel..."
          php artisan config:show app.debug > reports/security/laravel-config.txt || echo "Debug mode check failed"

          # Compter les vuln√©rabilit√©s critiques
          CRITICAL_COUNT=$(jq '[.[] | select(.severity == "high" or .severity == "critical")] | length' reports/security/composer-audit.json 2>/dev/null || echo "0")
          echo "critical-count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT

          echo "üîç Vuln√©rabilit√©s critiques trouv√©es: $CRITICAL_COUNT"

      - name: üîí Advanced SARIF security analysis
        continue-on-error: true
        if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'vulnerabilities-only' || github.event.inputs.scan_type == ''
        run: |
          echo "üîí Analyse SARIF avanc√©e..."

          # Installation de outils de s√©curit√© suppl√©mentaires
          composer require --dev vimeo/psalm || true

          # Analyse Psalm pour la s√©curit√©
          ./vendor/bin/psalm --output-format=json > reports/security/psalm-security.json || true

          # V√©rification des en-t√™tes de s√©curit√© dans les r√©ponses
          echo "üõ°Ô∏è V√©rification de la configuration de s√©curit√© web..."
          grep -r "X-Frame-Options\|Content-Security-Policy\|X-XSS-Protection" config/ > reports/security/security-headers.txt || true

      - name: üìä Security summary
        id: security-summary
        run: |
          echo "üìä G√©n√©ration du r√©sum√© de s√©curit√©..."

          CRITICAL_VULNS="${{ steps.vulnerability-check.outputs.critical-count || '0' }}"
          SECRETS_FOUND="${{ steps.secrets-scan.outputs.secrets-count || '0' }}"

          # D√©terminer le statut global
          if [ "$CRITICAL_VULNS" -gt 0 ] || [ "$SECRETS_FOUND" -gt 0 ]; then
            SECURITY_STATUS="failed"
            echo "‚ùå Probl√®mes de s√©curit√© d√©tect√©s"
          else
            SECURITY_STATUS="success"
            echo "‚úÖ Aucun probl√®me de s√©curit√© critique d√©tect√©"
          fi

          echo "status=$SECURITY_STATUS" >> $GITHUB_OUTPUT

          # Cr√©er un rapport de s√©curit√© d√©taill√©
          cat > reports/security/security-summary.md << EOF
          # üîí Rapport de S√©curit√© - $(date)

          ## üéØ Statut Global: $([ "$SECURITY_STATUS" = "success" ] && echo "‚úÖ S√âCURIS√â" || echo "‚ùå VULN√âRABILIT√âS D√âTECT√âES")

          ## üìä R√©sum√© des Analyses
          - **Vuln√©rabilit√©s critiques**: $CRITICAL_VULNS
          - **Secrets d√©tect√©s**: $SECRETS_FOUND
          - **Branche analys√©e**: ${{ github.ref_name }}
          - **Type de scan**: ${{ github.event.inputs.scan_type || 'full' }}

          ## üîç D√©tails des Analyses
          ### üõ°Ô∏è D√©tection de Secrets
          - Scan TruffleHog approfondi avec historique complet
          - Recherche de patterns Laravel sp√©cifiques
          - V√©rification des fichiers .env

          ### üîç √âvaluation des Vuln√©rabilit√©s
          - Audit Composer avec classification par s√©v√©rit√©
          - V√©rification des permissions de fichiers
          - Analyse de la configuration Laravel

          ### üîí Analyse SARIF
          - Scan Psalm pour la s√©curit√© du code
          - V√©rification des en-t√™tes de s√©curit√© web
          EOF

          # Rapport des probl√®mes critiques d√©tect√©s (non-bloquant)
          if [ "$SECURITY_STATUS" = "failed" ]; then
            echo "üö´ Scan de s√©curit√© - Vuln√©rabilit√©s critiques d√©tect√©es (non-bloquant)"
            echo "‚ö†Ô∏è Le workflow continue pour g√©n√©rer les rapports complets"
          fi

      - name: üì§ Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-deep-scan-${{ github.sha }}
          path: reports/security/
          retention-days: 90 # Conserver plus longtemps pour la s√©curit√©

  dependency-check:
    name: üîç Analyse OWASP des d√©pendances
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'dependencies-only' || github.event.inputs.scan_type == ''
    outputs:
      dependency-vulnerabilities: ${{ steps.dependency-analysis.outputs.vuln-count }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv

      - name: üì¶ Install Composer dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install Node.js dependencies
        run: |
          echo "üì¶ Installation des d√©pendances Node.js..."
          npm ci --prefer-offline --no-audit
          echo "‚úÖ D√©pendances Node.js install√©es"

      - name: üìÅ Create dependency reports directory
        run: mkdir -p reports/dependencies

      - name: üîç Validate suppression file
        run: |
          echo "üîç Validation du fichier de suppression..."
          if [ -f "dependency-check-suppressions.xml" ]; then
            echo "‚úÖ Fichier de suppression trouv√©"
            # V√©rifier la syntaxe XML
            xmllint --noout dependency-check-suppressions.xml && echo "‚úÖ Syntaxe XML valide" || echo "‚ö†Ô∏è Probl√®me de syntaxe XML"
          else
            echo "‚ö†Ô∏è Fichier de suppression non trouv√© - cr√©ation d'un fichier minimal"
            cat > dependency-check-suppressions.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <suppressions xmlns="https://jeremylong.github.io/DependencyCheck/dependency-suppression.1.3.xsd">
          </suppressions>
          EOF
          fi

      - name: üîç OWASP Dependency Check
        continue-on-error: true
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'Batistack'
          path: '.'
          format: 'ALL'
          args: >
            --enableRetired
            --enableExperimental
            --out reports/dependencies/
            --suppression dependency-check-suppressions.xml
            --exclude "**/node_modules/**"
            --exclude "**/vendor/**"
            --exclude "**/storage/**"
            --exclude "**/bootstrap/cache/**"

      - name: üìä Analyze dependency results
        id: dependency-analysis
        run: |
          echo "üìä Analyse des r√©sultats de d√©pendances..."

          # V√©rifier quels rapports ont √©t√© g√©n√©r√©s
          echo "üîç V√©rification des rapports g√©n√©r√©s..."
          ls -la reports/dependencies/ || echo "Aucun rapport trouv√©"

          # Compter les vuln√©rabilit√©s dans le rapport JSON
          VULN_COUNT=0
          HIGH_VULN_COUNT=0
          CRITICAL_VULN_COUNT=0

          if [ -f "reports/dependencies/dependency-check-report.json" ]; then
            echo "‚úÖ Rapport JSON trouv√© - analyse en cours..."

            # Compter toutes les vuln√©rabilit√©s
            VULN_COUNT=$(jq '[.dependencies[]?.vulnerabilities[]?] | length' reports/dependencies/dependency-check-report.json 2>/dev/null || echo "0")

            # Compter les vuln√©rabilit√©s critiques et √©lev√©es
            HIGH_VULN_COUNT=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "HIGH")] | length' reports/dependencies/dependency-check-report.json 2>/dev/null || echo "0")
            CRITICAL_VULN_COUNT=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "CRITICAL")] | length' reports/dependencies/dependency-check-report.json 2>/dev/null || echo "0")

            echo "üìä Analyse d√©taill√©e des vuln√©rabilit√©s:"
            echo "  - Total: $VULN_COUNT"
            echo "  - Critiques: $CRITICAL_VULN_COUNT"
            echo "  - √âlev√©es: $HIGH_VULN_COUNT"
          else
            echo "‚ö†Ô∏è Rapport JSON non trouv√© - v√©rification des autres formats..."

            # Essayer de lire le rapport XML si disponible
            if [ -f "reports/dependencies/dependency-check-report.xml" ]; then
              echo "‚úÖ Rapport XML trouv√©"
              VULN_COUNT=$(xmllint --xpath "count(//vulnerability)" reports/dependencies/dependency-check-report.xml 2>/dev/null || echo "0")
            fi
          fi

          echo "vuln-count=$VULN_COUNT" >> $GITHUB_OUTPUT
          echo "high-vuln-count=$HIGH_VULN_COUNT" >> $GITHUB_OUTPUT
          echo "critical-vuln-count=$CRITICAL_VULN_COUNT" >> $GITHUB_OUTPUT

          echo "üîç R√©sum√© des vuln√©rabilit√©s de d√©pendances:"
          echo "  - Total: $VULN_COUNT"
          echo "  - Critiques: $CRITICAL_VULN_COUNT"
          echo "  - √âlev√©es: $HIGH_VULN_COUNT"

          # Cr√©er un r√©sum√© d√©taill√© des d√©pendances
          cat > reports/dependencies/dependency-summary.md << EOF
          # üîç Rapport d'Analyse des D√©pendances - $(date)

          ## üìä R√©sum√© OWASP Dependency Check
          - **Vuln√©rabilit√©s totales**: $VULN_COUNT
          - **Vuln√©rabilit√©s critiques**: $CRITICAL_VULN_COUNT
          - **Vuln√©rabilit√©s √©lev√©es**: $HIGH_VULN_COUNT
          - **Projet**: Batistack
          - **Branche**: ${{ github.ref_name }}
          - **Commit**: ${{ github.sha }}

          ## üéØ Statut de S√©curit√©
          $(if [ "$CRITICAL_VULN_COUNT" -gt 0 ]; then
            echo "üî¥ **CRITIQUE** - Vuln√©rabilit√©s critiques d√©tect√©es"
          elif [ "$HIGH_VULN_COUNT" -gt 0 ]; then
            echo "üü° **ATTENTION** - Vuln√©rabilit√©s √©lev√©es d√©tect√©es"
          elif [ "$VULN_COUNT" -gt 0 ]; then
            echo "üü¢ **ACCEPTABLE** - Vuln√©rabilit√©s mineures d√©tect√©es"
          else
            echo "‚úÖ **S√âCURIS√â** - Aucune vuln√©rabilit√© d√©tect√©e"
          fi)

          ## üîó Rapports G√©n√©r√©s
          $(ls -la reports/dependencies/ | grep -E '\.(html|json|xml|csv)$' | awk '{print "- " $9}' || echo "- Aucun rapport disponible")

          ## üìã Actions Recommand√©es
          $(if [ "$CRITICAL_VULN_COUNT" -gt 0 ]; then
            echo "- üö® **URGENT**: Corriger imm√©diatement les vuln√©rabilit√©s critiques"
            echo "- üì¶ Mettre √† jour les d√©pendances vuln√©rables"
            echo "- üîç V√©rifier les alternatives s√©curis√©es"
          elif [ "$HIGH_VULN_COUNT" -gt 0 ]; then
            echo "- ‚ö†Ô∏è Planifier la correction des vuln√©rabilit√©s √©lev√©es"
            echo "- üì¶ Mettre √† jour les d√©pendances concern√©es"
          elif [ "$VULN_COUNT" -gt 0 ]; then
            echo "- üìù √âvaluer l'impact des vuln√©rabilit√©s mineures"
            echo "- üìÖ Planifier les mises √† jour lors du prochain cycle"
          else
            echo "- ‚úÖ Continuer la surveillance r√©guli√®re"
            echo "- üìÖ Maintenir les d√©pendances √† jour"
          fi)
          EOF

          # Afficher un r√©sum√© dans les logs
          if [ "$CRITICAL_VULN_COUNT" -gt 0 ]; then
            echo "üö® ALERTE CRITIQUE: $CRITICAL_VULN_COUNT vuln√©rabilit√©s critiques d√©tect√©es!"
          elif [ "$HIGH_VULN_COUNT" -gt 0 ]; then
            echo "‚ö†Ô∏è ATTENTION: $HIGH_VULN_COUNT vuln√©rabilit√©s √©lev√©es d√©tect√©es"
          elif [ "$VULN_COUNT" -gt 0 ]; then
            echo "‚ÑπÔ∏è INFO: $VULN_COUNT vuln√©rabilit√©s mineures d√©tect√©es"
          else
            echo "‚úÖ SUCC√àS: Aucune vuln√©rabilit√© d√©tect√©e"
          fi

      - name: üì§ Upload dependency reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-${{ github.sha }}
          path: reports/dependencies/
          retention-days: 60

  security-notifications:
    name: üö® Notifications de S√©curit√©
    runs-on: ubuntu-latest
    needs: [security-deep-scan, dependency-check]
    if: always()
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì• Download security reports
        if: always()
        uses: actions/download-artifact@v4
        with:
          pattern: '*-${{ github.sha }}'
          path: ./security-reports/
          merge-multiple: true

      - name: üîç Extract vulnerability details
        id: extract-details
        if: always()
        run: |
          echo "üîç Extraction des d√©tails des vuln√©rabilit√©s..."
          
          # Cr√©er les r√©pertoires n√©cessaires
          mkdir -p ./extracted-details
          
          # Initialiser les variables
          SECRETS_DETAILS=""
          DEPENDENCY_DETAILS=""
          CODE_VULNS_DETAILS=""
          
          # === EXTRACTION DES SECRETS ===
          echo "üîë Extraction des secrets d√©tect√©s..."
          
          # Utiliser d'abord le r√©sum√© structur√© s'il existe
          if [ -f "./security-reports/secrets-summary.md" ]; then
            echo "‚úÖ Utilisation du r√©sum√© structur√© des secrets"
            SECRETS_DETAILS=$(cat "./security-reports/secrets-summary.md")
            
            # Ajouter les d√©tails si des secrets ont √©t√© trouv√©s
            if [ -f "./security-reports/sensitive-patterns.txt" ] && [ -s "./security-reports/sensitive-patterns.txt" ]; then
              echo "" >> ./extracted-details/secrets.md
              echo "#### üìã D√©tails des D√©tections" >> ./extracted-details/secrets.md
              echo "" >> ./extracted-details/secrets.md
              echo "| Fichier | Ligne | Pattern D√©tect√© |" >> ./extracted-details/secrets.md
              echo "|---------|-------|-----------------|" >> ./extracted-details/secrets.md
              
              # Traiter les patterns sensibles (limiter √† 15 pour √©viter les issues trop longues)
              head -15 "./security-reports/sensitive-patterns.txt" | while IFS=':' read -r file line content; do
                if [ -n "$file" ] && [ -n "$line" ] && [ -n "$content" ]; then
                  # Nettoyer le contenu pour √©viter les caract√®res probl√©matiques
                  clean_content=$(echo "$content" | sed 's/|/\\|/g' | sed 's/`/\\`/g' | cut -c1-80)
                  clean_file=$(echo "$file" | sed 's/|/\\|/g')
                  echo "| \`$clean_file\` | $line | \`$clean_content...\` |" >> ./extracted-details/secrets.md
                fi
              done
              
              # Ajouter un avertissement si plus de 15 d√©tections
              total_secrets=$(wc -l < "./security-reports/sensitive-patterns.txt" 2>/dev/null || echo "0")
              if [ "$total_secrets" -gt 15 ]; then
                echo "" >> ./extracted-details/secrets.md
                echo "> ‚ö†Ô∏è **Note**: Seules les 15 premi√®res d√©tections sont affich√©es. Total: $total_secrets d√©tections." >> ./extracted-details/secrets.md
                echo "> Consultez les rapports complets dans les artifacts pour voir toutes les d√©tections." >> ./extracted-details/secrets.md
              fi
              
              # Ajouter le r√©sum√© structur√© au d√©but
              cat "./security-reports/secrets-summary.md" > ./extracted-details/secrets.md
              echo "" >> ./extracted-details/secrets.md
              cat ./extracted-details/secrets.md >> ./extracted-details/secrets.md
            else
              cat "./security-reports/secrets-summary.md" > ./extracted-details/secrets.md
            fi
            
            SECRETS_DETAILS=$(cat ./extracted-details/secrets.md)
          elif [ -f "./security-reports/sensitive-patterns.txt" ] && [ -s "./security-reports/sensitive-patterns.txt" ]; then
            echo "‚ö†Ô∏è Utilisation du fallback pour les secrets"
            echo "### üîë Secrets et Patterns Sensibles D√©tect√©s" > ./extracted-details/secrets.md
            echo "" >> ./extracted-details/secrets.md
            echo "| Fichier | Ligne | Pattern D√©tect√© |" >> ./extracted-details/secrets.md
            echo "|---------|-------|-----------------|" >> ./extracted-details/secrets.md
            
            # Traiter les patterns sensibles (limiter √† 15 pour √©viter les issues trop longues)
            head -15 "./security-reports/sensitive-patterns.txt" | while IFS=':' read -r file line content; do
              if [ -n "$file" ] && [ -n "$line" ] && [ -n "$content" ]; then
                # Nettoyer le contenu pour √©viter les caract√®res probl√©matiques
                clean_content=$(echo "$content" | sed 's/|/\\|/g' | sed 's/`/\\`/g' | cut -c1-80)
                clean_file=$(echo "$file" | sed 's/|/\\|/g')
                echo "| \`$clean_file\` | $line | \`$clean_content...\` |" >> ./extracted-details/secrets.md
              fi
            done
            
            total_secrets=$(wc -l < "./security-reports/sensitive-patterns.txt" 2>/dev/null || echo "0")
            if [ "$total_secrets" -gt 15 ]; then
              echo "" >> ./extracted-details/secrets.md
              echo "> ‚ö†Ô∏è **Note**: Seules les 15 premi√®res d√©tections sont affich√©es. Total: $total_secrets d√©tections." >> ./extracted-details/secrets.md
            fi
            
            SECRETS_DETAILS=$(cat ./extracted-details/secrets.md)
          else
            echo "‚úÖ Aucun secret d√©tect√©"
            SECRETS_DETAILS="### üîë Secrets et Patterns Sensibles\n‚úÖ Aucun secret ou pattern sensible d√©tect√©."
          fi
          
          # === EXTRACTION DES VULN√âRABILIT√âS DE D√âPENDANCES ===
          echo "üì¶ Extraction des vuln√©rabilit√©s de d√©pendances..."
          
          # Utiliser d'abord le r√©sum√© structur√© s'il existe
          if [ -f "./security-reports/dependency-summary.md" ]; then
            echo "‚úÖ Utilisation du r√©sum√© structur√© des d√©pendances"
            DEPENDENCIES_DETAILS=$(cat "./security-reports/dependency-summary.md")
             
             # Ajouter les d√©tails si des vuln√©rabilit√©s ont √©t√© trouv√©es
             if [ -f "./security-reports/dependency-check-report.json" ]; then
               # V√©rifier s'il y a des vuln√©rabilit√©s critiques ou √©lev√©es
               critical_count=$(jq -r '[.dependencies[]?.vulnerabilities[]? | select(.severity == "CRITICAL")] | length' "./security-reports/dependency-check-report.json" 2>/dev/null || echo "0")
               high_count=$(jq -r '[.dependencies[]?.vulnerabilities[]? | select(.severity == "HIGH")] | length' "./security-reports/dependency-check-report.json" 2>/dev/null || echo "0")
               
               if [ "$critical_count" -gt 0 ] || [ "$high_count" -gt 0 ]; then
                 echo "" >> ./extracted-details/dependencies.md
                 echo "#### üìã D√©tails des Vuln√©rabilit√©s" >> ./extracted-details/dependencies.md
                 echo "" >> ./extracted-details/dependencies.md
                 
                 # Extraire les vuln√©rabilit√©s critiques (limiter √† 8)
                 if [ "$critical_count" -gt 0 ]; then
                   echo "##### üî¥ Vuln√©rabilit√©s Critiques ($critical_count)" >> ./extracted-details/dependencies.md
                   echo "" >> ./extracted-details/dependencies.md
                   jq -r '.dependencies[]? | select(.vulnerabilities[]?.severity == "CRITICAL") | .fileName as $file | .vulnerabilities[] | select(.severity == "CRITICAL") | "- **" + .name + "** dans `" + $file + "`\n  - CVE: " + (.references[]?.name // "N/A") + "\n  - Score: " + (.cvssv3?.baseScore // .cvssv2?.score // "N/A" | tostring) + "\n"' "./security-reports/dependency-check-report.json" 2>/dev/null | head -24 >> ./extracted-details/dependencies.md
                 fi
                 
                 # Extraire les vuln√©rabilit√©s √©lev√©es (limiter √† 5)
                 if [ "$high_count" -gt 0 ]; then
                   echo "##### üü† Vuln√©rabilit√©s √âlev√©es ($high_count)" >> ./extracted-details/dependencies.md
                   echo "" >> ./extracted-details/dependencies.md
                   jq -r '.dependencies[]? | select(.vulnerabilities[]?.severity == "HIGH") | .fileName as $file | .vulnerabilities[] | select(.severity == "HIGH") | "- **" + .name + "** dans `" + $file + "`\n  - CVE: " + (.references[]?.name // "N/A") + "\n  - Score: " + (.cvssv3?.baseScore // .cvssv2?.score // "N/A" | tostring) + "\n"' "./security-reports/dependency-check-report.json" 2>/dev/null | head -15 >> ./extracted-details/dependencies.md
                 fi
                 
                 # Ajouter le r√©sum√© structur√© au d√©but
                 cat "./security-reports/dependency-summary.md" > ./extracted-details/dependencies.md
                 echo "" >> ./extracted-details/dependencies.md
                 cat ./extracted-details/dependencies.md >> ./extracted-details/dependencies.md
               else
                 cat "./security-reports/dependency-summary.md" > ./extracted-details/dependencies.md
               fi
             else
               cat "./security-reports/dependency-summary.md" > ./extracted-details/dependencies.md
             fi
             
             DEPENDENCIES_DETAILS=$(cat ./extracted-details/dependencies.md)
          elif [ -f "./security-reports/dependency-check-report.json" ]; then
            echo "‚ö†Ô∏è Utilisation du fallback pour les d√©pendances"
            echo "### üì¶ Vuln√©rabilit√©s de D√©pendances" > ./extracted-details/dependencies.md
            echo "" >> ./extracted-details/dependencies.md
            
            # Extraire les vuln√©rabilit√©s critiques et √©lev√©es
            jq -r '
              .dependencies[]? | 
              select(.vulnerabilities != null and (.vulnerabilities | length > 0)) |
              .vulnerabilities[] |
              select(.severity == "CRITICAL" or .severity == "HIGH") |
              "| \(.severity) | \(.name // "N/A") | \(.description // "N/A" | .[0:100]) | \(.references[0].url // "N/A") |"
            ' "./security-reports/dependency-check-report.json" 2>/dev/null > ./extracted-details/dep_vulns.tmp || echo "" > ./extracted-details/dep_vulns.tmp
            
            if [ -s "./extracted-details/dep_vulns.tmp" ]; then
              echo "| S√©v√©rit√© | CVE/Vuln√©rabilit√© | Description | R√©f√©rence |" >> ./extracted-details/dependencies.md
              echo "|----------|-------------------|-------------|-----------|" >> ./extracted-details/dependencies.md
              head -15 ./extracted-details/dep_vulns.tmp >> ./extracted-details/dependencies.md
              
              # Compter le total
              total_dep_vulns=$(wc -l < ./extracted-details/dep_vulns.tmp)
              if [ "$total_dep_vulns" -gt 15 ]; then
                echo "" >> ./extracted-details/dependencies.md
                echo "> ‚ö†Ô∏è **Note**: Seules les 15 vuln√©rabilit√©s les plus critiques sont affich√©es. Total: $total_dep_vulns vuln√©rabilit√©s." >> ./extracted-details/dependencies.md
              fi
            else
              echo "‚úÖ Aucune vuln√©rabilit√© critique ou √©lev√©e d√©tect√©e dans les d√©pendances." >> ./extracted-details/dependencies.md
            fi
            
            DEPENDENCIES_DETAILS=$(cat ./extracted-details/dependencies.md)
          else
            echo "‚úÖ Aucune vuln√©rabilit√© de d√©pendance d√©tect√©e"
            DEPENDENCIES_DETAILS="### üì¶ Vuln√©rabilit√©s de D√©pendances\n‚úÖ Aucune vuln√©rabilit√© d√©tect√©e dans les d√©pendances."
          fi
          
          # === EXTRACTION DES VULN√âRABILIT√âS DE CODE ===
          echo "üîç Extraction des vuln√©rabilit√©s de code..."
          if [ -f "./security-reports/composer-audit.json" ]; then
            echo "### üîç Vuln√©rabilit√©s de Code (Composer Audit)" > ./extracted-details/code-vulns.md
            echo "" >> ./extracted-details/code-vulns.md
            
            # Extraire les vuln√©rabilit√©s du composer audit
            jq -r '
              .[] |
              select(.severity == "high" or .severity == "critical") |
              "| \(.severity | ascii_upcase) | \(.package) | \(.title // "N/A" | .[0:80]) | \(.link // "N/A") |"
            ' "./security-reports/composer-audit.json" 2>/dev/null > ./extracted-details/code_vulns.tmp || echo "" > ./extracted-details/code_vulns.tmp
            
            if [ -s "./extracted-details/code_vulns.tmp" ]; then
              echo "| S√©v√©rit√© | Package | Titre | Lien |" >> ./extracted-details/code-vulns.md
              echo "|----------|---------|-------|------|" >> ./extracted-details/code-vulns.md
              head -10 ./extracted-details/code_vulns.tmp >> ./extracted-details/code-vulns.md
            else
              echo "‚úÖ Aucune vuln√©rabilit√© critique d√©tect√©e dans le code." >> ./extracted-details/code-vulns.md
            fi
            
            CODE_VULNS_DETAILS=$(cat ./extracted-details/code-vulns.md)
          else
            CODE_VULNS_DETAILS="### üîç Vuln√©rabilit√©s de Code\n‚ö†Ô∏è Rapport d'audit de code non disponible."
          fi
          
          # === EXTRACTION DES FICHIERS .ENV ===
          echo "üìÅ Extraction des fichiers .env d√©tect√©s..."
          ENV_FILES_DETAILS=""
          if [ -f "./security-reports/env-files.txt" ] && [ -s "./security-reports/env-files.txt" ]; then
            echo "### üìÅ Fichiers .env D√©tect√©s" > ./extracted-details/env-files.md
            echo "" >> ./extracted-details/env-files.md
            echo "‚ö†Ô∏è **ATTENTION**: Les fichiers .env suivants ont √©t√© d√©tect√©s :" >> ./extracted-details/env-files.md
            echo "" >> ./extracted-details/env-files.md
            while read -r line; do
              echo "- \`$line\`" >> ./extracted-details/env-files.md
            done < "./security-reports/env-files.txt"
            echo "" >> ./extracted-details/env-files.md
            echo "> üö® **Action requise**: V√©rifiez que ces fichiers ne sont pas commit√©s dans le repository." >> ./extracted-details/env-files.md
            
            ENV_FILES_DETAILS=$(cat ./extracted-details/env-files.md)
          else
            ENV_FILES_DETAILS="### üìÅ Fichiers .env\n‚úÖ Aucun fichier .env probl√©matique d√©tect√©."
          fi
          
          # === CR√âATION DU R√âSUM√â GLOBAL ===
          echo "üìä Cr√©ation du r√©sum√© global des d√©tections..."
          
          # Compter le total des d√©tections
          total_secrets=$(wc -l < "./security-reports/sensitive-patterns.txt" 2>/dev/null || echo "0")
          total_critical_deps=$(jq -r '[.dependencies[]?.vulnerabilities[]? | select(.severity == "CRITICAL")] | length' "./security-reports/dependency-check-report.json" 2>/dev/null || echo "0")
          total_high_deps=$(jq -r '[.dependencies[]?.vulnerabilities[]? | select(.severity == "HIGH")] | length' "./security-reports/dependency-check-report.json" 2>/dev/null || echo "0")
          total_env_files=$(find . -name "*.env*" -type f 2>/dev/null | wc -l || echo "0")
          
          # Cr√©er un r√©sum√© ex√©cutif
          echo "## üìä R√©sum√© Ex√©cutif des D√©tections" > ./extracted-details/executive-summary.md
          echo "" >> ./extracted-details/executive-summary.md
          echo "| Type de D√©tection | Nombre | Priorit√© |" >> ./extracted-details/executive-summary.md
          echo "|-------------------|--------|----------|" >> ./extracted-details/executive-summary.md
          echo "| üîë Secrets d√©tect√©s | $total_secrets | üî¥ Critique |" >> ./extracted-details/executive-summary.md
          echo "| üì¶ Vuln√©rabilit√©s critiques (deps) | $total_critical_deps | üî¥ Critique |" >> ./extracted-details/executive-summary.md
          echo "| üì¶ Vuln√©rabilit√©s √©lev√©es (deps) | $total_high_deps | üü† √âlev√©e |" >> ./extracted-details/executive-summary.md
          echo "| üìÑ Fichiers .env d√©tect√©s | $total_env_files | üü° Mod√©r√©e |" >> ./extracted-details/executive-summary.md
          echo "" >> ./extracted-details/executive-summary.md
          
          # Ajouter des recommandations prioritaires
          echo "### üéØ Actions Prioritaires" >> ./extracted-details/executive-summary.md
          echo "" >> ./extracted-details/executive-summary.md
          
          if [ "$total_secrets" -gt 0 ]; then
            echo "1. **üî¥ URGENT**: R√©vocation et rotation des secrets expos√©s" >> ./extracted-details/executive-summary.md
          fi
          
          if [ "$total_critical_deps" -gt 0 ]; then
            echo "2. **üî¥ CRITIQUE**: Mise √† jour des d√©pendances avec vuln√©rabilit√©s critiques" >> ./extracted-details/executive-summary.md
          fi
          
          if [ "$total_high_deps" -gt 0 ]; then
            echo "3. **üü† IMPORTANT**: Planifier la mise √† jour des d√©pendances √† risque √©lev√©" >> ./extracted-details/executive-summary.md
          fi
          
          if [ "$total_env_files" -gt 0 ]; then
            echo "4. **üü° RECOMMAND√â**: S√©curiser les fichiers de configuration" >> ./extracted-details/executive-summary.md
          fi
          
          if [ "$total_secrets" -eq 0 ] && [ "$total_critical_deps" -eq 0 ] && [ "$total_high_deps" -eq 0 ]; then
            echo "‚úÖ **Aucune action critique requise** - Le projet pr√©sente un bon niveau de s√©curit√©" >> ./extracted-details/executive-summary.md
          fi
          
          EXECUTIVE_SUMMARY=$(cat ./extracted-details/executive-summary.md)
          
          # === EXPORT DES VARIABLES ===
          echo "EXECUTIVE_SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$EXECUTIVE_SUMMARY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "SECRETS_DETAILS<<EOF" >> $GITHUB_ENV
          echo "$SECRETS_DETAILS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "DEPENDENCY_DETAILS<<EOF" >> $GITHUB_ENV
          echo "$DEPENDENCY_DETAILS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "CODE_VULNS_DETAILS<<EOF" >> $GITHUB_ENV
          echo "$CODE_VULNS_DETAILS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "ENV_FILES_DETAILS<<EOF" >> $GITHUB_ENV
          echo "$ENV_FILES_DETAILS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "‚úÖ Extraction des d√©tails termin√©e"

      - name: üö® Create critical security issue
        if: (needs.security-deep-scan.outputs.critical-vulnerabilities > 0 || needs.dependency-check.outputs.critical-vuln-count > 0 || needs.security-deep-scan.outputs.secrets-found > 0) && (github.event.inputs.create_issue == 'true' || github.event.inputs.create_issue == '')
        uses: actions/github-script@v7
        with:
          script: |
            const criticalVulns = '${{ needs.security-deep-scan.outputs.critical-vulnerabilities || 0 }}';
            const dependencyVulns = '${{ needs.dependency-check.outputs.dependency-vulnerabilities || 0 }}';
            const criticalDepVulns = '${{ needs.dependency-check.outputs.critical-vuln-count || 0 }}';
            const highDepVulns = '${{ needs.dependency-check.outputs.high-vuln-count || 0 }}';
            const secretsFound = '${{ needs.security-deep-scan.outputs.secrets-found || 0 }}';

            // D√©terminer le niveau de criticit√©
            const isCritical = parseInt(criticalVulns) > 0 || parseInt(criticalDepVulns) > 0 || parseInt(secretsFound) > 0;
            const isHigh = parseInt(highDepVulns) > 0;

            const severity = isCritical ? 'CRITIQUE' : (isHigh ? '√âLEV√âE' : 'MOD√âR√âE');
            const emoji = isCritical ? 'üö®' : (isHigh ? '‚ö†Ô∏è' : '‚ÑπÔ∏è');

            const title = `${emoji} ALERTE S√âCURIT√â ${severity} - ${new Date().toISOString().split('T')[0]}`;
            const body = `## ${emoji} Vuln√©rabilit√©s ${severity} D√©tect√©es

            Le scan de s√©curit√© approfondi a d√©tect√© des vuln√©rabilit√©s sur la branche \`${{ github.ref_name }}\`.

            ${{ env.EXECUTIVE_SUMMARY }}

            ### üìä R√©sum√© D√©taill√© des Menaces
            - **üî¥ Vuln√©rabilit√©s critiques (code)**: ${criticalVulns}
            - **üî¥ Vuln√©rabilit√©s critiques (d√©pendances)**: ${criticalDepVulns}
            - **üü° Vuln√©rabilit√©s √©lev√©es (d√©pendances)**: ${highDepVulns}
            - **üì¶ Total vuln√©rabilit√©s de d√©pendances**: ${dependencyVulns}
            - **üîë Secrets/Credentials d√©tect√©s**: ${secretsFound}

            ### ${isCritical ? 'üö® ACTIONS URGENTES REQUISES' : 'üìã ACTIONS RECOMMAND√âES'}
            ${isCritical ? `
            - [ ] **PRIORIT√â 1**: Corriger imm√©diatement les vuln√©rabilit√©s critiques
            - [ ] **PRIORIT√â 2**: Supprimer/s√©curiser les secrets d√©tect√©s
            - [ ] **PRIORIT√â 3**: Mettre √† jour les d√©pendances critiques
            - [ ] **PRIORIT√â 4**: Relancer le scan apr√®s corrections
            ` : `
            - [ ] √âvaluer l'impact des vuln√©rabilit√©s d√©tect√©es
            - [ ] Planifier les mises √† jour de d√©pendances
            - [ ] Programmer les corrections dans le prochain sprint
            - [ ] Surveiller les nouvelles vuln√©rabilit√©s
            `}

            ## üîç D√âTAILS DES D√âTECTIONS

            ${{ env.SECRETS_DETAILS }}

            ${{ env.DEPENDENCIES_DETAILS }}

            ${{ env.CODE_VULNERABILITIES_DETAILS }}

            ${{ env.ENV_FILES_DETAILS }}

            ## üìã GUIDE DE R√âSOLUTION

            ### üîß √âtapes de Correction Recommand√©es

            #### Pour les Secrets D√©tect√©s:
            1. **Identification**: V√©rifiez chaque secret list√© ci-dessus
            2. **Suppression**: Retirez les secrets du code source
            3. **Rotation**: Changez imm√©diatement les cl√©s/tokens compromis
            4. **S√©curisation**: Utilisez des variables d'environnement ou des services de gestion de secrets
            5. **Historique**: Nettoyez l'historique Git si n√©cessaire

            #### Pour les Vuln√©rabilit√©s de D√©pendances:
            1. **Mise √† jour**: \`composer update\` pour les packages PHP
            2. **V√©rification**: \`npm audit fix\` pour les packages Node.js
            3. **Alternatives**: Recherchez des alternatives s√©curis√©es si les mises √† jour ne sont pas disponibles
            4. **Suppression**: Utilisez le fichier \`dependency-check-suppressions.xml\` pour les faux positifs

            #### Pour les Vuln√©rabilit√©s de Code:
            1. **Analyse**: Examinez chaque vuln√©rabilit√© list√©e
            2. **Correction**: Appliquez les correctifs recommand√©s
            3. **Test**: V√©rifiez que les corrections n'introduisent pas de r√©gressions
            4. **Documentation**: Documentez les changements effectu√©s

            ### üîó Ressources et Rapports
            - [üîó Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [üìù Commit](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
            - [üìä Rapports de s√©curit√© d√©taill√©s](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [üìã Branche analys√©e](${{ github.server_url }}/${{ github.repository }}/tree/${{ github.ref_name }})

            ### üìã D√©tails Techniques
            - **Type de scan**: ${{ github.event.inputs.scan_type || 'full' }}
            - **D√©clencheur**: ${{ github.event_name }}
            - **Environnement**: ${{ github.ref_name }}
            - **SHA**: \`${{ github.sha }}\`
            - **Date du scan**: ${new Date().toISOString()}

            ### ‚ö†Ô∏è CONFIDENTIALIT√â
            **Cette issue contient des informations sensibles de s√©curit√©.**
            - Ne pas partager publiquement les d√©tails des vuln√©rabilit√©s
            - Limiter l'acc√®s aux personnes autoris√©es
            - Traiter avec la plus haute confidentialit√©
            - Supprimer cette issue apr√®s r√©solution des probl√®mes

            ### ‚úÖ Validation Post-Correction
            Apr√®s avoir corrig√© les vuln√©rabilit√©s:
            1. Relancez le workflow de s√©curit√©: \`workflow_dispatch\`
            2. V√©rifiez que tous les scans passent au vert
            3. Fermez cette issue en documentant les actions prises
            4. Consid√©rez un audit de s√©curit√© suppl√©mentaire si n√©cessaire

            ---
            *Issue cr√©√©e automatiquement par le Security Deep Scan v3.0*
            *Derni√®re mise √† jour: ${new Date().toISOString()}*`;

            const labels = ['security', 'vulnerability'];
            if (isCritical) {
              labels.push('critical', 'urgent', 'P0');
            } else if (isHigh) {
              labels.push('high', 'P1');
            } else {
              labels.push('medium', 'P2');
            }

            await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: labels
              });

      - name: üìä Security scan summary
        if: always()
        run: |
          echo "## üîí R√âSUM√â COMPLET DU SCAN DE S√âCURIT√â"
          echo "=================================="
          echo ""
          echo "### üìã Informations G√©n√©rales"
          echo "- **Branche**: ${{ github.ref_name }}"
          echo "- **Commit**: ${{ github.sha }}"
          echo "- **D√©clencheur**: ${{ github.event_name }}"
          echo "- **Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "### üîç R√©sultats des Analyses"
          echo "#### Security Deep Scan"
          echo "- Vuln√©rabilit√©s critiques: ${{ needs.security-deep-scan.outputs.critical-vulnerabilities || 'N/A' }}"
          echo "- Secrets d√©tect√©s: ${{ needs.security-deep-scan.outputs.secrets-found || 'N/A' }}"
          echo "- Statut: ${{ needs.security-deep-scan.result }}"
          echo ""
          echo "#### Dependency Check"
          echo "- Vuln√©rabilit√©s critiques: ${{ needs.dependency-check.outputs.critical-vuln-count || 'N/A' }}"
          echo "- Vuln√©rabilit√©s √©lev√©es: ${{ needs.dependency-check.outputs.high-vuln-count || 'N/A' }}"
          echo "- Total vuln√©rabilit√©s: ${{ needs.dependency-check.outputs.dependency-vulnerabilities || 'N/A' }}"
          echo "- Statut: ${{ needs.dependency-check.result }}"
          echo ""
          echo "### üéØ Actions Prises"
          if [[ "${{ needs.security-deep-scan.outputs.critical-vulnerabilities || 0 }}" -gt 0 ]] || [[ "${{ needs.dependency-check.outputs.critical-vuln-count || 0 }}" -gt 0 ]] || [[ "${{ needs.security-deep-scan.outputs.secrets-found || 0 }}" -gt 0 ]]; then
            echo "- ‚úÖ Issue de s√©curit√© critique cr√©√©e"
            echo "- üö® Notification d'urgence envoy√©e"
            echo "- ‚ö†Ô∏è D√©ploiement bloqu√© jusqu'√† r√©solution"
          else
            echo "- ‚úÖ Aucune vuln√©rabilit√© critique d√©tect√©e"
            echo "- üü¢ S√©curit√© valid√©e pour le d√©ploiement"
          fi
          echo ""
          echo "### üìä M√©triques de Performance"
          echo "- Dur√©e Security Deep Scan: ~${{ needs.security-deep-scan.outputs.scan-duration || 'N/A' }}"
          echo "- Dur√©e Dependency Check: ~${{ needs.dependency-check.outputs.scan-duration || 'N/A' }}"
          echo ""
          echo "### üîó Liens Utiles"
          echo "- [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          echo "- [Commit Details](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})"
          echo "- [Security Reports](artifacts)"
          echo ""
          echo "=================================="
          echo "üîí Scan de s√©curit√© termin√© avec succ√®s"

  summary:
    name: üìã R√©sum√© S√©curit√©
    runs-on: ubuntu-latest
    needs: [security-deep-scan, dependency-check, security-notifications]
    if: always()
    steps:
      - name: üìã Generate security summary
        run: |
          echo "## üîí R√©sum√© Security Deep Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üéØ Statut: ${{ needs.security-deep-scan.outputs.security-status == 'success' && '‚úÖ S√âCURIS√â' || '‚ùå VULN√âRABILIT√âS' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä D√©tections:" >> $GITHUB_STEP_SUMMARY
          echo "- **Vuln√©rabilit√©s critiques**: ${{ needs.security-deep-scan.outputs.critical-vulnerabilities || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Secrets d√©tect√©s**: ${{ needs.security-deep-scan.outputs.secrets-found || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Vuln√©rabilit√©s d√©pendances**: ${{ needs.dependency-check.outputs.dependency-vulnerabilities || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîç Type de scan: ${{ github.event.inputs.scan_type || 'full' }}" >> $GITHUB_STEP_SUMMARY
          echo "### üìÖ Ex√©cut√© le: $(date)" >> $GITHUB_STEP_SUMMARY
