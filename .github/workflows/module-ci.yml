name: ğŸ—ï¸ Module CI/CD

on:
  pull_request:
    branches: [master]
    paths:
      # ModÃ¨les de tous les modules
      - 'app/Models/**'
      # Composants Livewire de tous les modules
      - 'app/Livewire/**'
      # Migrations de tous les modules
      - 'database/migrations/**'
      # Tests de tous les modules
      - 'tests/Feature/**'
      - 'tests/Unit/**'
      # Factories et seeders
      - 'database/factories/**'
      - 'database/seeders/**'
  push:
    branches: [develop]

jobs:
  detect-changed-modules:
    name: ğŸ” DÃ©tection des modules modifiÃ©s
    runs-on: ubuntu-latest
    outputs:
      modules: ${{ steps.build-modules.outputs.modules }}
      has-changes: ${{ steps.build-modules.outputs.has-changes }}
      detection-success: ${{ steps.build-modules.outputs.detection-success }}

    steps:
      - uses: actions/checkout@v4

      - name: DÃ©tecter les changements par module
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            chantiers:
              - 'app/Models/Chantiers/**'
              - 'app/Livewire/Chantier/**'
              - 'app/Livewire/Chantiers/**'
              - 'database/migrations/**chantier**'
              - 'tests/**/*Chantier*'
            rh:
              - 'app/Models/RH/**'
              - 'app/Livewire/Humans/**'
              - 'database/migrations/**employe**'
              - 'database/migrations/**rh**'
              - 'tests/**/*RH*'
              - 'tests/**/*Employe*'
            tiers:
              - 'app/Models/Tiers/**'
              - 'app/Livewire/Tiers/**'
              - 'database/migrations/**tiers**'
              - 'tests/**/*Tiers*'
            commerce:
              - 'app/Models/Commerce/**'
              - 'database/migrations/**devis**'
              - 'database/migrations/**facture**'
              - 'database/migrations/**commande**'
              - 'tests/**/*Commerce*'
            core:
              - 'app/Models/Core/**'
              - 'app/Livewire/Core/**'
              - 'database/migrations/**core**'
              - 'tests/**/*Core*'

      - name: Construire la liste des modules
        id: build-modules
        run: |
          echo "ğŸ” Construction de la liste des modules modifiÃ©s..."

          MODULES=()

          if [ "${{ steps.changes.outputs.chantiers }}" = "true" ]; then
            MODULES+=("chantiers")
            echo "âœ… Module Chantiers dÃ©tectÃ©"
          fi
          if [ "${{ steps.changes.outputs.rh }}" = "true" ]; then
            MODULES+=("rh")
            echo "âœ… Module RH dÃ©tectÃ©"
          fi
          if [ "${{ steps.changes.outputs.tiers }}" = "true" ]; then
            MODULES+=("tiers")
            echo "âœ… Module Tiers dÃ©tectÃ©"
          fi
          if [ "${{ steps.changes.outputs.commerce }}" = "true" ]; then
            MODULES+=("commerce")
            echo "âœ… Module Commerce dÃ©tectÃ©"
          fi
          if [ "${{ steps.changes.outputs.core }}" = "true" ]; then
            MODULES+=("core")
            echo "âœ… Module Core dÃ©tectÃ©"
          fi

          # Construire le JSON
          if [ ${#MODULES[@]} -gt 0 ]; then
            # Utiliser jq pour crÃ©er un JSON valide et compact
            MODULES_JSON=$(printf '%s\n' "${MODULES[@]}" | jq -R . | jq -s -c .)

            # Valider le JSON avant de l'Ã©crire
            if echo "$MODULES_JSON" | jq . > /dev/null 2>&1; then
              echo "modules=$MODULES_JSON" >> $GITHUB_OUTPUT
              echo "has-changes=true" >> $GITHUB_OUTPUT
              echo "ğŸ“¦ Modules dÃ©tectÃ©s: ${MODULES[*]}"
              echo "ğŸ“¦ JSON gÃ©nÃ©rÃ©: $MODULES_JSON"
            else
              echo "âŒ Erreur: JSON invalide gÃ©nÃ©rÃ©"
              echo "modules=[]" >> $GITHUB_OUTPUT
              echo "has-changes=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "modules=[]" >> $GITHUB_OUTPUT
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Aucun module dÃ©tectÃ©"
          fi

          echo "detection-success=true" >> $GITHUB_OUTPUT
          echo "âœ… DÃ©tection terminÃ©e avec succÃ¨s"

  module-tests:
    name: ğŸ§ª Tests Module ${{ matrix.module }}
    runs-on: ubuntu-latest
    needs: detect-changed-modules
    if: needs.detect-changed-modules.outputs.has-changes == 'true' && needs.detect-changed-modules.outputs.detection-success == 'true'
    strategy:
      fail-fast: false
      matrix:
        module: ${{ fromJson(needs.detect-changed-modules.outputs.modules) }}
        php-version: [8.3, 8.4]

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mbstring, bcmath, pdo_mysql, sqlite3

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{  hashFiles('composer.lock') }}
          restore-keys: |
            composer-

      - name: Cache NPM dependencies
        uses: actions/cache@v4
        with:
          path: node_modules
          key: npm-${{  hashFiles('package-lock.json') }}
          restore-keys: |
            npm-

      - name: Setup test environment
        run: |
          cp .env.github .env
          php artisan key:generate

      - name: Run module-specific tests
        run: |
          # Tests unitaires du module
          if [ -d "tests/Unit" ]; then
            php artisan test tests/Unit --filter=${{ matrix.module }} --coverage-text || true
          fi

          # Tests fonctionnels du module
          if [ -d "tests/Feature" ]; then
            php artisan test tests/Feature --filter=${{ matrix.module }} --coverage-text || true
          fi

          # Tests gÃ©nÃ©riques si pas de tests spÃ©cifiques
          php artisan test --filter=${{ matrix.module }} --coverage-text || echo "âš ï¸ Aucun test spÃ©cifique trouvÃ© pour ${{ matrix.module }}"

      - name: Check module documentation
        run: |
          MODULE_DOC="resources/docs/1.0/${{ matrix.module }}.md"
          if [ ! -f "$MODULE_DOC" ]; then
            echo "âš ï¸ Documentation manquante pour le module ${{ matrix.module }}"
            echo "ğŸ“ CrÃ©ez le fichier: $MODULE_DOC"
            # Ne pas faire Ã©chouer le build pour la documentation manquante
          else
            echo "âœ… Documentation trouvÃ©e pour ${{ matrix.module }}"
          fi

  security-scan:
    name: ğŸ”’ Analyse de sÃ©curitÃ©
    runs-on: ubuntu-latest
    needs: detect-changed-modules
    if: needs.detect-changed-modules.outputs.has-changes == 'true' && needs.detect-changed-modules.outputs.detection-success == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Run security audit
        run: |
          # Audit des dÃ©pendances Composer
          composer audit || echo "âš ï¸ VulnÃ©rabilitÃ©s dÃ©tectÃ©es dans les dÃ©pendances"

          # VÃ©rification des fichiers sensibles
          echo "ğŸ” VÃ©rification des fichiers sensibles..."
          if grep -r "password\|secret\|key" app/ --include="*.php" | grep -v "// " | grep -v "/*" | head -5; then
            echo "âš ï¸ Mots-clÃ©s sensibles dÃ©tectÃ©s - VÃ©rifiez qu'aucun secret n'est en dur"
          fi

  performance-check:
    name: âš¡ VÃ©rification des performances
    runs-on: ubuntu-latest
    needs: detect-changed-modules
    if: needs.detect-changed-modules.outputs.has-changes == 'true' && needs.detect-changed-modules.outputs.detection-success == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          extensions: mbstring, bcmath, pdo_mysql, sqlite3

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Setup test environment
        run: |
          cp .env.github .env
          php artisan key:generate

      - name: Check for N+1 queries
        run: |
          # Tests de performance si ils existent
          if [ -d "tests/Performance" ]; then
            echo "ğŸ§ª ExÃ©cution des tests de performance..."

            # VÃ©rifier que les factories sont correctes avant les tests
            echo "ğŸ” VÃ©rification des factories..."
            php artisan tinker --execute="
              try {
                \App\Models\RH\Employe::factory()->make();
                echo 'EmployeFactory: OK' . PHP_EOL;
              } catch (Exception \$e) {
                echo 'EmployeFactory: ERREUR - ' . \$e->getMessage() . PHP_EOL;
              }

              try {
                \App\Models\Chantiers\Chantiers::factory()->make();
                echo 'ChantiersFactory: OK' . PHP_EOL;
              } catch (Exception \$e) {
                echo 'ChantiersFactory: ERREUR - ' . \$e->getMessage() . PHP_EOL;
              }
            " || echo "âš ï¸ Erreur lors de la vÃ©rification des factories"

            # ExÃ©cuter les tests de performance avec gestion d'erreur
            if php artisan test tests/Performance --coverage-text; then
              echo "âœ… Tests de performance rÃ©ussis"
            else
              echo "âŒ Ã‰chec des tests de performance"
              echo "ğŸ” VÃ©rification des patterns N+1 dans le code..."

              # Analyse statique des patterns N+1
              if grep -r "foreach.*->.*->" app/Models/ app/Livewire/ --include="*.php" | head -5; then
                echo "âš ï¸ Patterns N+1 potentiels dÃ©tectÃ©s:"
                grep -r "foreach.*->.*->" app/Models/ app/Livewire/ --include="*.php" | head -5
                echo ""
                echo "ğŸ’¡ Recommandations:"
                echo "   - Utilisez with() pour l'eager loading"
                echo "   - ConsidÃ©rez load() pour le lazy eager loading"
                echo "   - VÃ©rifiez les relations dans vos modÃ¨les"
              fi

              # Ne pas faire Ã©chouer le workflow pour les tests de performance
              echo "âš ï¸ Tests de performance ignorÃ©s (erreurs de configuration)"
            fi
          else
            echo "â„¹ï¸ Aucun test de performance configurÃ©"

            # VÃ©rification basique des requÃªtes N+1 dans le code
            echo "ğŸ” Recherche de patterns N+1 potentiels..."
            if grep -r "foreach.*->.*->" app/Models/ app/Livewire/ --include="*.php" | head -3; then
              echo "âš ï¸ Patterns N+1 potentiels dÃ©tectÃ©s - VÃ©rifiez l'utilisation d'eager loading"
            else
              echo "âœ… Aucun pattern N+1 Ã©vident dÃ©tectÃ©"
            fi
          fi

          # VÃ©rification basique des requÃªtes N+1 dans le code
          echo "ğŸ” Recherche de patterns N+1 potentiels..."
          if grep -r "foreach.*->.*->" app/Models/ app/Livewire/ --include="*.php" | head -3; then
            echo "âš ï¸ Patterns N+1 potentiels dÃ©tectÃ©s - VÃ©rifiez l'utilisation d'eager loading"
          fi

  code-quality:
    name: ğŸ“Š QualitÃ© du code
    runs-on: ubuntu-latest
    needs: detect-changed-modules
    if: needs.detect-changed-modules.outputs.has-changes == 'true' && needs.detect-changed-modules.outputs.detection-success == 'true'
    outputs:
      pint-status: ${{ steps.pint-check.outputs.status }}
      phpstan-status: ${{ steps.phpstan-check.outputs.status }}
      report-path: ${{ steps.generate-report.outputs.report-path }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Create reports directory
        run: mkdir -p reports/code-quality

      - name: Run Laravel Pint
        id: pint-check
        run: |
          echo "ğŸ¨ ExÃ©cution de Laravel Pint..."
          PINT_STATUS="success"
          PINT_OUTPUT=""

          if command -v ./vendor/bin/pint &> /dev/null; then
            echo "âœ… Laravel Pint dÃ©tectÃ©"

            # ExÃ©cuter Pint avec capture de sortie
            if ./vendor/bin/pint --test --format=json > reports/code-quality/pint-report.json 2>&1; then
              echo "âœ… Laravel Pint: Aucun problÃ¨me de style dÃ©tectÃ©"
              PINT_OUTPUT="âœ… Code style conforme aux standards Laravel"
            else
              echo "âŒ Laravel Pint: ProblÃ¨mes de style dÃ©tectÃ©s"
              PINT_STATUS="failure"

              # GÃ©nÃ©rer un rapport lisible
              ./vendor/bin/pint --test > reports/code-quality/pint-output.txt 2>&1 || true
              PINT_OUTPUT=$(cat reports/code-quality/pint-output.txt | head -20)

              echo "ğŸ“‹ ProblÃ¨mes dÃ©tectÃ©s:"
              echo "$PINT_OUTPUT"
            fi
          else
            echo "âš ï¸ Laravel Pint non configurÃ©"
            PINT_STATUS="skipped"
            PINT_OUTPUT="âš ï¸ Laravel Pint non configurÃ© dans le projet"
          fi

          echo "status=$PINT_STATUS" >> $GITHUB_OUTPUT
          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$PINT_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run PHPStan
        id: phpstan-check
        run: |
          echo "ğŸ” ExÃ©cution de PHPStan..."
          PHPSTAN_STATUS="success"
          PHPSTAN_OUTPUT=""

          if [ -f "phpstan.neon.dist" ] && command -v ./vendor/bin/phpstan &> /dev/null; then
            echo "âœ… PHPStan dÃ©tectÃ©"

            # ExÃ©cuter PHPStan avec capture de sortie
            if ./vendor/bin/phpstan analyse --memory-limit=2G --error-format=json > reports/code-quality/phpstan-report.json 2>&1; then
              echo "âœ… PHPStan: Aucune erreur dÃ©tectÃ©e"
              PHPSTAN_OUTPUT="âœ… Analyse statique rÃ©ussie - Aucune erreur dÃ©tectÃ©e"
            else
              echo "âŒ PHPStan: Erreurs dÃ©tectÃ©es"
              PHPSTAN_STATUS="failure"

              # GÃ©nÃ©rer un rapport lisible
              ./vendor/bin/phpstan analyse --memory-limit=2G > reports/code-quality/phpstan-output.txt 2>&1 || true
              PHPSTAN_OUTPUT=$(cat reports/code-quality/phpstan-output.txt | head -30)

              echo "ğŸ“‹ Erreurs dÃ©tectÃ©es:"
              echo "$PHPSTAN_OUTPUT"
            fi
          else
            echo "âš ï¸ PHPStan non configurÃ©"
            PHPSTAN_STATUS="skipped"
            PHPSTAN_OUTPUT="âš ï¸ PHPStan non configurÃ© dans le projet"
          fi

          echo "status=$PHPSTAN_STATUS" >> $GITHUB_OUTPUT
          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$PHPSTAN_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate Quality Report
        id: generate-report
        if: always()
        run: |
          REPORT_FILE="reports/code-quality/quality-report-$(date +%Y%m%d-%H%M%S).md"

          cat > "$REPORT_FILE" << 'EOF'
          # ğŸ“Š Rapport de QualitÃ© du Code

          **Date:** $(date '+%Y-%m-%d %H:%M:%S')
          **Commit:** ${{ github.sha }}
          **Branche:** ${{ github.ref_name }}
          **Modules modifiÃ©s:** ${{ needs.detect-changed-modules.outputs.modules }}

          ## ğŸ¨ Laravel Pint (Code Style)
          **Statut:** ${{ steps.pint-check.outputs.status }}

          ```
          ${{ steps.pint-check.outputs.output }}
          ```

          ## ğŸ” PHPStan (Analyse Statique)
          **Statut:** ${{ steps.phpstan-check.outputs.status }}

          ```
          ${{ steps.phpstan-check.outputs.output }}
          ```

          ## ğŸ“‹ RÃ©sumÃ©

          | Outil | Statut | Description |
          |-------|--------|-------------|
          | Laravel Pint | ${{ steps.pint-check.outputs.status }} | VÃ©rification du style de code |
          | PHPStan | ${{ steps.phpstan-check.outputs.status }} | Analyse statique du code |

          ## ğŸ”§ Actions RecommandÃ©es

          EOF

          # Ajouter des recommandations basÃ©es sur les rÃ©sultats
          if [ "${{ steps.pint-check.outputs.status }}" = "failure" ]; then
            echo "### ğŸ¨ Corrections Laravel Pint" >> "$REPORT_FILE"
            echo "- ExÃ©cutez \`./vendor/bin/pint\` pour corriger automatiquement les problÃ¨mes de style" >> "$REPORT_FILE"
            echo "- VÃ©rifiez la configuration dans \`pint.json\`" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
          fi

          if [ "${{ steps.phpstan-check.outputs.status }}" = "failure" ]; then
            echo "### ğŸ” Corrections PHPStan" >> "$REPORT_FILE"
            echo "- Corrigez les erreurs d'analyse statique dÃ©tectÃ©es" >> "$REPORT_FILE"
            echo "- Ajoutez les annotations de type manquantes" >> "$REPORT_FILE"
            echo "- VÃ©rifiez la configuration dans \`phpstan.neon.dist\`" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
          fi

          echo "report-path=$REPORT_FILE" >> $GITHUB_OUTPUT

          echo "ğŸ“„ Rapport gÃ©nÃ©rÃ©: $REPORT_FILE"
          cat "$REPORT_FILE"

      - name: Upload Quality Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-report-${{ github.run_number }}
          path: reports/code-quality/
          retention-days: 30

      - name: Create Issue on Failure
        if: failure() && (steps.pint-check.outputs.status == 'failure' || steps.phpstan-check.outputs.status == 'failure')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Lire le rapport gÃ©nÃ©rÃ©
            const reportPath = '${{ steps.generate-report.outputs.report-path }}';
            let reportContent = '';

            try {
              reportContent = fs.readFileSync(reportPath, 'utf8');
            } catch (error) {
              reportContent = `Erreur lors de la lecture du rapport: ${error.message}`;
            }

            // DÃ©terminer les labels basÃ©s sur les Ã©checs
            const labels = ['ci-failure', 'code-quality'];
            if ('${{ steps.pint-check.outputs.status }}' === 'failure') {
              labels.push('code-style');
            }
            if ('${{ steps.phpstan-check.outputs.status }}' === 'failure') {
              labels.push('static-analysis');
            }

            // CrÃ©er le ticket
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Ã‰chec de la qualitÃ© du code - ${context.payload.head_commit?.message || 'Commit ' + context.sha.substring(0, 7)}`,
              body: `## ğŸš¨ Ã‰chec de la QualitÃ© du Code

            **Workflow:** ${context.workflow}
            **Run ID:** ${context.runId}
            **Commit:** ${context.sha}
            **Branche:** ${context.ref.replace('refs/heads/', '')}
            **Auteur:** @${context.actor}

            ### ğŸ“Š DÃ©tails des Ã‰checs

            | Outil | Statut |
            |-------|--------|
            | Laravel Pint | ${{ steps.pint-check.outputs.status }} |
            | PHPStan | ${{ steps.phpstan-check.outputs.status }} |

            ### ğŸ“‹ Rapport Complet

            ${reportContent}

            ### ğŸ”— Liens Utiles

            - [Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - [Commit](${context.payload.repository.html_url}/commit/${context.sha})

            ### âœ… CritÃ¨res d'Acceptation

            - [ ] Corriger tous les problÃ¨mes de style Laravel Pint
            - [ ] RÃ©soudre toutes les erreurs PHPStan
            - [ ] VÃ©rifier que les tests passent
            - [ ] Mettre Ã  jour la documentation si nÃ©cessaire

            ---

            *Ce ticket a Ã©tÃ© crÃ©Ã© automatiquement par le workflow CI/CD.*`,
              labels: labels,
              assignees: [context.actor]
            });

            console.log(`Ticket crÃ©Ã©: ${issue.data.html_url}`);

            // Ajouter un commentaire avec des dÃ©tails supplÃ©mentaires
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.data.number,
              body: `### ğŸ”§ Guide de RÃ©solution Rapide

            #### Pour Laravel Pint:
            \`\`\`bash
            # Corriger automatiquement les problÃ¨mes de style
            ./vendor/bin/pint

            # VÃ©rifier les corrections
            ./vendor/bin/pint --test
            \`\`\`

            #### Pour PHPStan:
            \`\`\`bash
            # Analyser le code
            ./vendor/bin/phpstan analyse --memory-limit=2G

            # GÃ©nÃ©rer un baseline (si nÃ©cessaire)
            ./vendor/bin/phpstan analyse --generate-baseline
            \`\`\`

            #### Commandes utiles:
            \`\`\`bash
            # ExÃ©cuter tous les outils de qualitÃ©
            composer lint
            composer test:lint

            # Tests complets
            php artisan test
            \`\`\`

            @${context.actor} Merci de corriger ces problÃ¨mes avant de merger.`
            });

      - name: Fail job if quality checks failed
        if: steps.pint-check.outputs.status == 'failure' || steps.phpstan-check.outputs.status == 'failure'
        run: |
          echo "âŒ Ã‰chec des vÃ©rifications de qualitÃ© du code"
          echo "ğŸ“Š Laravel Pint: ${{ steps.pint-check.outputs.status }}"
          echo "ğŸ” PHPStan: ${{ steps.phpstan-check.outputs.status }}"
          echo ""
          echo "ğŸ“„ Consultez le rapport dÃ©taillÃ© dans les artifacts"
          echo "ğŸ« Un ticket a Ã©tÃ© crÃ©Ã© automatiquement pour le suivi"
          exit 1
